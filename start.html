<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPB FA2 ST44/46 设备故障诊断与处理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            color: white;
            position: relative;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .search-container {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
        }
        
        .search-box {
            display: flex;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            padding: 8px 15px;
            align-items: center;
        }
        
        .search-box input {
            background: transparent;
            border: none;
            color: white;
            padding: 5px 10px;
            width: 100%;
            font-size: 1rem;
            outline: none;
        }
        
        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .search-box i {
            color: white;
            font-size: 1.2rem;
        }
        
        .breadcrumb {
            background: #e9ecef;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            color: #495057;
            margin-bottom: 15px;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .tree-container, .info-container {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 25px;
            transition: transform 0.3s ease;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .tree-container {
            position: relative;
        }
        
        .tree-container:hover, .info-container:hover {
            transform: translateY(-5px);
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 动态树形结构样式 */
        .tree-node {
            list-style: none;
            margin: 5px 0;
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .tree-node:hover {
            background-color: #f1f8ff;
        }
        
        .tree-node.active {
            background-color: #e3f2fd;
            border-left: 3px solid #3498db;
        }
        
        .tree-node .icon {
            margin-right: 8px;
            color: #3498db;
            width: 20px;
            display: inline-block;
        }
        
        .tree-node .title {
            font-size: 1rem;
        }
        
        .tree-children {
            padding-left: 20px;
            margin-left: 10px;
            border-left: 1px dashed #bdc3c7;
        }
        
        /* 信息展示区域 */
        .info-display {
            padding: 20px;
            line-height: 1.6;
            overflow-y: auto;
            max-height: 350px;
        }
        
        .info-header {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-content {
            margin-bottom: 20px;
        }
        
        .info-content ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .info-content li {
            margin-bottom: 8px;
        }
        
        .info-content p {
            margin-bottom: 10px;
        }
        
        /* 措施信息框样式 */
        .measures-info {
            background: #e3f2fd;
            border-left: 4px solid #3498db;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.95rem;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #3498db;
            padding: 15px;
            border-radius: 8px;
            margin-top: 25px;
            font-size: 0.95rem;
        }
        
        .info-box h3 {
            margin-bottom: 8px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .instructions {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .instructions ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        
        .instructions li {
            margin: 8px 0;
        }
        
        .no-results {
            color: #e74c3c;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        .notes-panel {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .notes-panel.hidden {
            display: none;
        }
        
        .placeholder-text {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
        }
        
        .placeholder-text i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #adb5bd;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .section-title {
                font-size: 1.5rem;
            }
            
            .search-container {
                position: static;
                transform: none;
                width: 100%;
                margin-top: 15px;
            }
            
            header {
                padding-bottom: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tools"></i> IPB FA2 ST44/46 设备故障诊断与处理</h1>
            <div class="subtitle">设备故障类别、失效项与处理措施</div>
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="搜索故障类别、失效项...">
                </div>
            </div>
        </header>
        
        <div class="breadcrumb" id="breadcrumb"></div>
        
        <div class="content">
            <div class="tree-container">
                <h2 class="section-title"><i class="fas fa-sitemap"></i>故障分类树</h2>
                <div class="no-results" id="noResults">未找到匹配的故障项</div>
                <div id="treeContainer"></div>
            </div>
            
            <div class="info-container">
                <h2 class="section-title"><i class="fas fa-clipboard-list"></i>故障处理信息</h2>
                <div class="info-display" id="contentArea">
                    <div class="placeholder-text">
                        <i class="fas fa-hand-pointer"></i>
                        <p>请从左侧树状图中选择一个故障项</p>
                    </div>
                </div>
                
                <div class="notes-panel hidden" id="notesPanel"></div>
                
                <div class="info-box">
                    <h3><i class="fas fa-info-circle"></i>注意！</h3>
                    <p>1. 气动过程如遇列表中未出现的失效，对于2B项，先更换对应的失效口工装，再直接盲板测试阀泄漏</p>
                    <p>2. 如遇failure memory，列表中未出现的先查看excel failure memory，确认是否是磁阀线圈电阻问题，如不是更换所Pin</p>
                    <p>3. 此页面仅作参考，可靠内容见FTA。<br>最新更新于2025.9.7</p>
                </div>
                
                <div class="info-box">
                    <h3><i class="fas fa-info-circle"></i>使用说明</h3>
                    <p>1. 点击左侧树状结构中的故障项查看详细信息</p>
                    <p>2. 点击文件夹图标可展开/折叠子目录</p>
                    <p>3. 在搜索框中输入故障类别或失效项可快速定位</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 故障树应用类
        class FaultTreeApp {
            constructor() {
                this.treeContainer = document.getElementById('treeContainer');
                this.contentArea = document.getElementById('contentArea');
                this.notesPanel = document.getElementById('notesPanel');
                this.searchInput = document.getElementById('searchInput');
                this.breadcrumb = document.getElementById('breadcrumb');
                this.noResults = document.getElementById('noResults');

                this.currentPath = [];
                this.globalNotes = [];
                this.loadedNodes = new Map();
                this.imagePreloader = new Set();

                this.init();
            }

            async init() {
                // 使用内联JSON数据，避免外部文件依赖
                const mainData = await this.getMainData();
                this.buildTree(mainData, null);
                this.bindEvents();
            }

            // 获取主要数据
            async getMainData() {
                return [
                    {
                        "title": "FTA-重点关注",
                        "type": "folder",
                        "children": [
                            {
                                "title": "⭐铝丝/油壶工装-专项 (近期重点关注)",
                                "type": "folder",
                                "children": [
                                    {
                                        "title": "dPRes3OS2_2B_IPB 超上限等多项故障",
                                        "type": "page",
                                        "rootCause": "工装PRV口粘铝丝<br>密封圈损坏",
                                        "measures": [
                                            "1 待复测件流转下去，再点Auto stop 开门",
                                            "2 无需拆工装，使用无尘布清洁PRV黑色密封圈后继续生产",
                                            "3 无效后更换油壶工装",
                                            "4 第1次换下来的工装整体清洁一遍，同时更换黑色密封圈，待验收后使用",
                                            "5 如该问题当班发生2次及以上，需要找TEF利用停机时间清洁Res3OS(507)通道过滤芯"
                                        ]
                                    }
                                ]
                            },
                            {
                                "title": "⭐工装/高压阀/O型圈",
                                "type": "folder",
                                "children": [
                                    {
                                        "title": "gPRes3PRV2_2B_IPB 超下限等多项故障",
                                        "type": "page",
                                        "rootCause": "1.工装泄漏 <br>2.503/504/508高压阀其中某个高压阀泄漏 <br>3.508高压阀底座密封圈损坏",
                                        "measures": [
                                            "1.优先更换WC工装，再更换Res工装",
                                            "2.盲板检查503或504和508 通道泄漏，那个通道漏量大，先解决该通道密封性",
                                            "3.如盲板测试无泄漏，则更换508高压阀底座的O型圈"
                                        ]
                                    },
                                    {
                                        "title": "gPRes3PRV2_2B_IPB 超下限等故障",
                                        "type": "page",
                                        "rootCause": "1 工装泄漏<br>2 高压阀泄漏<br>3 O型圈泄漏",
                                        "measures": [
                                            "1.优先更换WC工装，再更换Res工装",
                                            "2.盲板检查有508 通道，如有泄漏更换508高压阀",
                                            "3.如盲板检查无泄漏，更换508高压阀安装块底座O型圈"
                                        ]
                                    }
                                ]
                            },
                            {
                                "title": "FailureMemory",
                                "type": "page",
                                "rootCause": "1.RPS掉落<br>2.马达电源Pin卡涩，通讯不良 <br>3.与Dummy ECU通讯不良",
                                "measures": [
                                    "1.查看不良件是否有RPS",
                                    "2.更换Coil unit，若有效，线下更换换下的Coil unit的马达电源/RPS/PS/LIPS的连接pin",
                                    "3.更换新Dummy ECU (无须关机直接更换)",
                                    "4 更换并清洁Dummy ECU端的连接pin",
                                    "5 检查并整理Dummy ECU与Coil工装之间线缆，检查线缆插头"
                                ]
                            },
                            {
                                "title": "dummy ecu更换流程",
                                "type": "page",
                                "rootCause": "Dummy ECU更换前需下电",
                                "measures": [
                                    "1.进入AutoBlid_IPB界面",
                                    "2.查看该界面的按钮是否被点亮，如下图则表示上电状态",
                                    "3.点击被点亮的按钮，保持与下图相同的界面，则为下电状态 ，然后更换dummy ECU"
                                ]
                            }
                        ]
                    },
                    {
                        "title": "原材料",
                        "type": "folder",
                        "children": [
                            {
                                "title": "PSMC1_2C_IPB",
                                "type": "page",
                                "rootCause": "来料异常",
                                "measures": [
                                    "1 联系质量技术原查看PSMC1是否有损伤",
                                    "2 如有损伤立刻调监控排查C40装配有无异常，并将调查结果分享到群里",
                                    "3 要求质量技术员汇报给质量工程师"
                                ]
                            },
                            {
                                "title": "gPA32_2B_IPB等多项同时超下限",
                                "type": "page",
                                "rootCause": "C40 PS冲压点位偏移",
                                "measures": [
                                    "1.master件和盲件测试设备有无泄漏",
                                    "2.收集报废件拿到其他产线测试",
                                    "3.若其他产线复测也是相同的报废项，将报废件交给质量做气泡实验",
                                    "4.同时需要检查40工位冲压PS有无异常"
                                ]
                            }
                        ]
                    },
                    {
                        "title": "工装/设备",
                        "type": "folder",
                        "children": [
                            {
                                "title": "卡工装",
                                "type": "page",
                                "rootCause": "工装/设备异常",
                                "measures": [
                                    "1 如果工装在测试位没有动作，取出工装后工艺打磨底板导向Pin及底板两侧边缘",
                                    "2 如果工装出来一半卡在出口处，联系TEF排查内外轨道是否对齐",
                                    "3 如频繁发生（当班发生2次及以上）升级汇报"
                                ]
                            }
                        ]
                    },
                    {
                        "title": "设备",
                        "type": "folder",
                        "children": [
                            {
                                "title": "WPC或产品歪斜",
                                "type": "page",
                                "rootCause": "设备异常",
                                "measures": [
                                    "为避免撞机，应先开门扶正问题WPC或产品，确保没有撞机风险再复位或移动轴。"
                                ]
                            },
                            {
                                "title": "卡架子",
                                "type": "page",
                                "rootCause": "设备问题",
                                "measures": [
                                    "1 调低lifter速度",
                                    "2 将WPC感应传感器向远离lifter方向调整（适用SCU3）",
                                    "3 工艺安装行车记录仪（如有监控可跳过此步）",
                                    "4 如无效，联系TEF利用停机时间检查 SCU X方向的位置，检查挡块位置"
                                ]
                            },
                            {
                                "title": "安全模块报警",
                                "type": "page",
                                "rootCause": "设备异常",
                                "measures": [
                                    "1.首先在Mpad上需要检查EtherCATDiagnose和PnozEVO01界面并拍照",
                                    "2.根据收集的信息判断出是EtherCAT还是Pilz报警，切勿盲目关机重启",
                                    "3.如果是EtherCAT报警，根据EtherCATDiagnose报错内容找到对应的连接线和模块",
                                    "4.如果是Pilz报警，根据Zone0和Zone1报错内容检查对应的安全门&模块&spindle轴sensor"
                                ]
                            }
                        ]
                    }
                ];
            }

            buildTree(data, parentElement, basePath = '') {
                const fragment = document.createDocumentFragment();

                data.forEach((item, index) => {
                    const node = this.createTreeNode(item, basePath, index);
                    fragment.appendChild(node);
                });

                if (parentElement) {
                    parentElement.innerHTML = '';
                    parentElement.appendChild(fragment);
                } else {
                    this.treeContainer.appendChild(fragment);
                }
            }

            createTreeNode(item, basePath, key) {
                const li = document.createElement('div');
                li.className = 'tree-node';
                li.dataset.key = key;
                li.dataset.path = basePath;

                let hasChildren = false;
                if (item.type === 'folder') {
                    hasChildren = true;
                    if (item.children && item.children.length > 0) {
                        li.classList.add('children');
                    }
                }

                if (!hasChildren && item.type === 'page') {
                    li.classList.add('leaf');
                }

                const iconSpan = document.createElement('span');
                iconSpan.className = 'icon';
                
                // 设置图标
                if (item.type === 'folder') {
                    iconSpan.innerHTML = '<i class="fas fa-folder"></i>';
                } else {
                    iconSpan.innerHTML = '<i class="fas fa-file-medical"></i>';
                }
                
                li.appendChild(iconSpan);

                const titleSpan = document.createElement('span');
                titleSpan.className = 'title';
                titleSpan.textContent = item.title;
                li.appendChild(titleSpan);

                li.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.selectNode(li, item, basePath);
                });

                return li;
            }

            async selectNode(element, item, basePath) {
                document.querySelectorAll('.tree-node.active').forEach(n => n.classList.remove('active'));
                element.classList.add('active');

                this.currentPath = this.getBreadcrumbPath(element);
                this.updateInheritedNotes();
                this.renderBreadcrumb();

                if (item.type === 'page') {
                    this.renderContent(item);
                    this.preloadImagesInContent(item);
                } else {
                    if (element.classList.contains('expanded')) {
                        this.collapseNode(element);
                    } else {
                        await this.expandNode(element, item, basePath);
                    }
                }
            }

            getBreadcrumbPath(element) {
                const path = [];
                let curr = element;
                while (curr && curr.classList.contains('tree-node')) {
                    const title = curr.querySelector('.title').textContent;
                    path.unshift({ title, element: curr });
                    const parent = curr.parentElement.closest('.tree-node');
                    if (parent && parent !== curr) {
                        curr = parent;
                    } else {
                        break;
                    }
                }
                return path;
            }

            renderBreadcrumb() {
                const parts = this.currentPath.map(p => p.title);
                this.breadcrumb.innerHTML = parts.length > 0 ? '路径: ' + parts.join(' > ') : '';
            }

            updateInheritedNotes() {
                const notes = [];
                let tempPath = [...this.currentPath];

                while (tempPath.length > 0) {
                    const step = tempPath.shift();
                    const el = step.element;
                    const key = el.dataset.key;
                    const path = el.dataset.path;
                    const data = this.findItemByPathAndKey(path, key);
                    if (data && data.notes) {
                        notes.unshift(data.notes);
                    }
                }

                if (notes.length > 0) {
                    this.notesPanel.innerHTML = notes.map(n => `⚠️ ${n}`).join('<br>');
                    this.notesPanel.classList.remove('hidden');
                } else {
                    this.notesPanel.classList.add('hidden');
                }
            }

            async expandNode(parentNode, item, basePath) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-children';
                parentNode.parentNode.insertBefore(childrenContainer, parentNode.nextSibling);
                parentNode.dataset.container = 'true';
                parentNode.classList.add('expanded');

                let data = [];
                if (item.children) {
                    data = item.children;
                }

                // 更新文件夹图标
                const icon = parentNode.querySelector('.icon i');
                icon.classList.remove('fa-folder');
                icon.classList.add('fa-folder-open');

                this.buildTree(data, childrenContainer, item.source || basePath);
            }

            collapseNode(parentNode) {
                const next = parentNode.nextSibling;
                if (next && next.classList.contains('tree-children')) {
                    next.remove();
                }
                parentNode.classList.remove('expanded');
                
                // 更新文件夹图标
                const icon = parentNode.querySelector('.icon i');
                icon.classList.remove('fa-folder-open');
                icon.classList.add('fa-folder');
            }

            findItemByPathAndKey(jsonPath, key) {
                // 简化实现，直接使用主数据
                const mainData = this.getMainDataSync();
                return this.traverseToFind(mainData, parseInt(key));
            }

            getMainDataSync() {
                // 返回同步数据（简化实现）
                return [
                    {
                        "title": "FTA-重点关注",
                        "type": "folder",
                        "children": [
                            // 这里的数据结构与getMainData方法相同
                        ]
                    },
                    // 其他数据...
                ];
            }

            traverseToFind(arr, key, depth = 0) {
                for (let i = 0; i < arr.length; i++) {
                    if (i === key && depth === 0) return arr[i];
                    if (arr[i].children) {
                        const found = this.traverseToFind(arr[i].children, key, depth + 1);
                        if (found) return found;
                    }
                }
                return null;
            }

            renderContent(item) {
                let html = '';

                if (item.rootCause) {
                    html += `<h3 class="info-header"><i class="fas fa-search"></i>根本原因</h3>
                            <div class="info-content">${item.rootCause}</div>`;
                }

                if (item.measures && item.measures.length > 0) {
                    html += `<h3 class="info-header"><i class="fas fa-tools"></i>维修措施</h3>
                            <div class="info-content"><ul>`;
                    item.measures.forEach(m => {
                        html += `<li>${m}</li>`;
                    });
                    html += `</ul></div>`;
                }

                if (item.content) {
                    html += `<div class="info-content">${item.content}</div>`;
                }

                this.contentArea.innerHTML = html || '<p class="placeholder">暂无内容。</p>';
            }

            preloadImagesInContent(item) {
                // 简化实现，实际项目中可以预加载图片
            }

            bindEvents() {
                this.searchInput.addEventListener('input', (e) => {
                    this.filterTree(e.target.value.trim());
                });
            }

            filterTree(keyword) {
                if (!keyword) {
                    document.querySelectorAll('.tree-children, .tree-node').forEach(el => {
                        el.style.display = '';
                    });
                    this.noResults.style.display = 'none';
                    return;
                }

                const allNodes = document.querySelectorAll('.tree-node');
                const matched = new Set();

                allNodes.forEach(node => {
                    const title = node.querySelector('.title').textContent;
                    if (title.toLowerCase().includes(keyword.toLowerCase())) {
                        this.markNodeAndParents(node, matched);
                    }
                });

                allNodes.forEach(node => {
                    if (matched.has(node)) {
                        node.style.display = '';
                        const parentChildren = node.nextSibling;
                        if (parentChildren && parentChildren.classList.contains('tree-children')) {
                            parentChildren.style.display = '';
                        }
                    } else {
                        node.style.display = 'none';
                        const children = node.nextSibling;
                        if (children && children.classList.contains('tree-children')) {
                            children.style.display = 'none';
                        }
                    }
                });

                // 显示/隐藏无结果消息
                if (matched.size === 0) {
                    this.noResults.style.display = 'block';
                } else {
                    this.noResults.style.display = 'none';
                }
            }

            markNodeAndParents(node, set) {
                let curr = node;
                while (curr) {
                    set.add(curr);
                    const parentLi = curr.parentElement.closest('.tree-node');
                    if (parentLi) {
                        curr = parentLi;
                    } else {
                        break;
                    }
                }
            }

            showError(msg) {
                this.contentArea.innerHTML = `<p style="color:#f48484;">❌❌ ${msg}</p>`;
            }
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', () => {
            new FaultTreeApp();
        });
    </script>
</body>
</html>
